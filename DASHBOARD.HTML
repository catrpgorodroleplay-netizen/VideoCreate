<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - CREATE</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo" onclick="location.href='index.html'">CREATE</div>
        <div class="user-menu">
            <span>–ü—Ä–∏–≤–µ—Ç, <span id="userName"></span>!</span>
            <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="#" onclick="logout()">–í—ã–π—Ç–∏</a>
        </div>
    </header>

    <div class="dashboard">
        <div class="section">
            <h2>–ú–æ–π –∫–∞–Ω–∞–ª</h2>
            <div id="channelInfo">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–Ω–∞–ª–µ -->
            </div>
            <button onclick="showCreateChannel()" id="createChannelBtn">–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
            <button onclick="location.href='upload.html'">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
        </div>

        <div class="section">
            <h2>–ú–æ–∏ –≤–∏–¥–µ–æ</h2>
            <div class="videos-grid" id="myVideos">
                <!-- –ú–æ–∏ –≤–∏–¥–µ–æ -->
            </div>
        </div>

        <div class="section">
            <h2>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä CREATE</h2>
            <div class="messages-container">
                <div class="users-list">
                    <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                    <div id="usersList">
                        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                    </div>
                </div>
                <div class="chat-area">
                    <div class="messages-list" id="messagesList">
                        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                    </div>
                    <div class="message-input">
                        <input type="text" id="messageText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                        <button onclick="sendMessageToUser()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let selectedUser = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadUserData();
            loadMyVideos();
            loadUsers();
        });

        function loadUserData() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            document.getElementById('userName').textContent = user.username;
            loadChannelInfo(user.id);
        }

        async function loadChannelInfo(userId) {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–Ω–∞–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const response = await fetch(`/api/user/channel/${userId}`);
            const channel = await response.json();
            
            if (channel) {
                document.getElementById('channelInfo').innerHTML = `
                    <h3>${channel.name}</h3>
                    <p>${channel.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                    <p>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏: ${channel.subscribers}</p>
                    <button onclick="editChannel(${channel.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button onclick="deleteChannel(${channel.id})">–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª</button>
                `;
                document.getElementById('createChannelBtn').style.display = 'none';
            }
        }

        async function loadMyVideos() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const response = await fetch(`/api/user/videos/${user.id}`);
            const videos = await response.json();
            displayMyVideos(videos);
        }

        function displayMyVideos(videos) {
            const container = document.getElementById('myVideos');
            if (videos.length === 0) {
                container.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≤–∏–¥–µ–æ</p>';
                return;
            }

            container.innerHTML = videos.map(video => `
                <div class="video-card">
                    <div class="video-thumbnail">üé¨</div>
                    <div class="video-info">
                        <div class="video-title">${video.title}</div>
                        <div class="video-stats">
                            <span>üëÅÔ∏è ${video.views}</span>
                            <span>‚ù§Ô∏è ${video.likes}</span>
                        </div>
                        <button onclick="editVideo(${video.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button onclick="deleteVideo(${video.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadUsers() {
            const response = await fetch('/api/users');
            const users = await response.json();
            displayUsers(users);
        }

        function displayUsers(users) {
            const container = document.getElementById('usersList');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            container.innerHTML = users
                .filter(user => user.id !== currentUser.id)
                .map(user => `
                    <div class="user-item" onclick="selectUser(${user.id}, '${user.username}')">
                        ${user.username}
                    </div>
                `).join('');
        }

        function selectUser(userId, username) {
            selectedUser = userId;
            document.querySelectorAll('.user-item').forEach(item => item.classList.remove('selected'));
            event.target.classList.add('selected');
            loadMessages(userId);
        }

        async function loadMessages(userId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const messages = await fetch(`/api/messages/${currentUser.id}/${userId}`);
            const messagesData = await messages.json();
            displayMessages(messagesData);
        }

        function displayMessages(messages) {
            const container = document.getElementById('messagesList');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.from_user === currentUser.id ? 'own' : ''}">
                    <strong>${msg.from_username}:</strong> ${msg.text}
                    <div class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessageToUser() {
            if (!selectedUser) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }

            const text = document.getElementById('messageText').value;
            if (!text.trim()) return;

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            await sendMessage(currentUser.id, selectedUser, text);
            
            document.getElementById('messageText').value = '';
            loadMessages(selectedUser);
        }

        function showCreateChannel() {
            const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞:');
            const description = prompt('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞:');
            
            if (name) {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                createChannel(user.id, name, description);
                location.reload();
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            location.href = 'index.html';
        }

        async function deleteVideo(videoId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –≤–∏–¥–µ–æ?')) {
                await fetch(`/api/videos/${videoId}`, { method: 'DELETE' });
                loadMyVideos();
            }
        }

        async function deleteChannel(channelId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª? –í—Å–µ –≤–∏–¥–µ–æ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                await fetch(`/api/channels/${channelId}`, { method: 'DELETE' });
                location.reload();
            }
        }
    </script>
</body>
</html>
