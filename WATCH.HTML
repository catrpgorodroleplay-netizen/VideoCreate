<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–µ–æ - CREATE</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo" onclick="location.href='index.html'">CREATE</div>
        <div class="user-menu">
            <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="dashboard.html" id="dashboardLink">–ö–∞–±–∏–Ω–µ—Ç</a>
        </div>
    </header>

    <div class="watch-container">
        <div class="video-player">
            <video id="mainVideo" controls autoplay>
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ
            </video>
        </div>

        <div class="video-info">
            <h1 id="videoTitle"></h1>
            <div class="video-actions">
                <button onclick="likeVideo()" id="likeBtn">‚ù§Ô∏è <span id="likeCount">0</span></button>
                <button onclick="subscribeToChannel()" id="subscribeBtn">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                <span id="viewCount">0 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
            </div>
            <div class="channel-info">
                <h3 id="channelName"></h3>
                <p id="channelSubscribers"></p>
            </div>
            <p id="videoDescription"></p>
        </div>

        <div class="comments-section">
            <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
            <div class="comment-form">
                <textarea id="commentText" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                <button onclick="addComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            <div id="commentsList">
                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
            </div>
        </div>

        <div class="recommendations-sidebar">
            <h3>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ</h3>
            <div id="sidebarVideos">
                <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let currentVideoId = null;
        let currentChannelId = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadVideoData();
            loadRecommendationsSidebar();
        });

        function loadVideoData() {
            const urlParams = new URLSearchParams(window.location.search);
            currentVideoId = urlParams.get('id');
            
            if (!currentVideoId) {
                alert('–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                location.href = 'index.html';
                return;
            }

            fetch(`/api/videos/${currentVideoId}`)
                .then(response => response.json())
                .then(video => {
                    document.getElementById('videoTitle').textContent = video.title;
                    document.getElementById('videoDescription').textContent = video.description;
                    document.getElementById('viewCount').textContent = video.views + ' –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤';
                    document.getElementById('likeCount').textContent = video.likes;
                    document.getElementById('channelName').textContent = video.channel_name;
                    document.getElementById('channelSubscribers').textContent = video.subscribers + ' –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤';
                    
                    const videoElement = document.getElementById('mainVideo');
                    videoElement.src = video.video_url;
                    
                    currentChannelId = video.channel_id;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
                    checkSubscription();
                });
        }

        async function likeVideo() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) {
                alert('–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å –≤–∏–¥–µ–æ');
                return;
            }

            await likeVideo(user.id, currentVideoId);
            location.reload();
        }

        async function subscribeToChannel() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) {
                alert('–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è');
                return;
            }

            await subscribe(user.id, currentChannelId);
            location.reload();
        }

        async function checkSubscription() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) return;

            const response = await fetch(`/api/check-subscription/${user.id}/${currentChannelId}`);
            const isSubscribed = await response.json();
            
            const btn = document.getElementById('subscribeBtn');
            btn.textContent = isSubscribed ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
        }

        async function addComment() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) {
                alert('–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å');
                return;
            }

            const text = document.getElementById('commentText').value;
            if (!text.trim()) return;

            await fetch('/api/comments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    video_id: currentVideoId,
                    user_id: user.id,
                    text: text
                })
            });

            document.getElementById('commentText').value = '';
            loadComments();
        }

        async function loadComments() {
            const response = await fetch(`/api/comments/${currentVideoId}`);
            const comments = await response.json();
            
            const container = document.getElementById('commentsList');
            container.innerHTML = comments.map(comment => `
                <div class="comment">
                    <strong>${comment.username}:</strong> ${comment.text}
                </div>
            `).join('');
        }

        function loadRecommendationsSidebar() {
            fetch('/api/recommendations')
                .then(response => response.json())
                .then(videos => {
                    const container = document.getElementById('sidebarVideos');
                    container.innerHTML = videos.map(video => `
                        <div class="sidebar-video" onclick="location.href='watch.html?id=${video.id}'">
                            <div class="sidebar-thumbnail">üé¨</div>
                            <div class="sidebar-info">
                                <div class="sidebar-title">${video.title}</div>
                                <div class="sidebar-channel">${video.channel_name}</div>
                            </div>
                        </div>
                    `).join('');
                });
        }
    </script>
</body>
</html>
