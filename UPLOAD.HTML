<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ - CREATE</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo" onclick="location.href='index.html'">CREATE</div>
        <div class="user-menu">
            <a href="dashboard.html">–ö–∞–±–∏–Ω–µ—Ç</a>
            <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
        </div>
    </header>

    <div class="dashboard">
        <div class="section">
            <h2>üìπ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</h2>
            
            <div id="uploadStatus"></div>
            
            <form class="upload-form" id="uploadForm" enctype="multipart/form-data">
                <input type="text" id="videoTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ" required>
                <textarea id="videoDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ"></textarea>
                
                <div class="upload-area" onclick="document.getElementById('videoFile').click()">
                    <div class="upload-icon">üìÅ</div>
                    <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∏–¥–µ–æ —Ñ–∞–π–ª–∞</p>
                    <span id="fileName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                    <p class="file-info">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, WebM (–¥–æ 100MB)</p>
                </div>
                
                <input type="file" id="videoFile" accept="video/*" style="display: none" onchange="showFileName(this)">
                
                <button type="button" onclick="uploadVideo()" id="uploadBtn">üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
            </form>
            
            <div id="progressContainer" style="display: none; margin-top: 1rem;">
                <div class="progress-bar">
                    <div class="progress" id="uploadProgress"></div>
                </div>
                <div id="progressText">–ó–∞–≥—Ä—É–∑–∫–∞: 0%</div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let selectedFile = null;
        let userChannel = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            const user = localStorage.getItem('currentUser');
            if (!user) {
                location.href = 'auth.html';
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–∞–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userData = JSON.parse(user);
            await loadUserChannel(userData.id);
        });

        async function loadUserChannel(userId) {
            try {
                const response = await fetch(`/api/user/channel/${userId}`);
                userChannel = await response.json();
                
                if (!userChannel) {
                    showStatus('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–∞–Ω–∞–ª!', 'error');
                    document.getElementById('uploadBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error loading channel:', error);
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–∞', 'error');
            }
        }

        function showFileName(input) {
            const fileName = document.getElementById('fileName');
            
            if (input.files.length > 0) {
                selectedFile = input.files[0];
                fileName.textContent = selectedFile.name;
                fileName.className = 'file-selected';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
                if (selectedFile.size > 100 * 1024 * 1024) {
                    showStatus('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 100MB)', 'error');
                    document.getElementById('uploadBtn').disabled = true;
                } else {
                    showStatus('', '');
                    document.getElementById('uploadBtn').disabled = false;
                }
            }
        }

        async function uploadVideo() {
            if (!selectedFile) {
                showStatus('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª', 'error');
                return;
            }

            if (!userChannel) {
                showStatus('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–∞–Ω–∞–ª –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ', 'error');
                return;
            }

            const title = document.getElementById('videoTitle').value;
            const description = document.getElementById('videoDescription').value;
            const user = JSON.parse(localStorage.getItem('currentUser'));

            if (!title.trim()) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ', 'error');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('uploadBtn').disabled = true;

            const formData = new FormData();
            formData.append('video', selectedFile);
            formData.append('channelId', userChannel.id);
            formData.append('title', title);
            formData.append('description', description);
            formData.append('user', JSON.stringify(user));

            try {
                const response = await fetch('/api/upload-video', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!', 'success');
                    setTimeout(() => {
                        location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + result.error, 'error');
                    document.getElementById('uploadBtn').disabled = false;
                }
            } catch (error) {
                console.error('Upload error:', error);
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.textContent = message;
            statusEl.className = type;
        }
    </script>
</body>
</html>
